#creates array named connections that contains the remote address and owning process
$connections=Get-NetTCPConnection | foreach { $_.RemoteAddress,$_.OwningProcess }

#creates empty hash table to store ip addresses and connections
$program_connections = @{}

#iterate through $connections to:
#find and add the readable program name to $program_connections
For ($i=0; $i -lt $connections.Length; $i++) {
    # get the current process id as an int
	$current_pair_id = (2 * $i) - 1
	$id = $connections[$current_pair_id] -as [int]

	# get the readable program name from the id
	$program=Get-Process -Id  $id | Select-Object ProcessName
	#format program name to remove extra characters
	$program = $program -as [string]
	$program = $program.Split("=,}")
	$program = $program[1]

	# get the ip address
	$ip = $connections[$current_pair_id + 1] -as [string]

	#check hash table for key of ip address
	If ($program_connections.containsKey($ip)) {
		#if program name not in array, add program name to array
		If (-not ($program_connections[$ip] -contains $program)){
			$program_connections[$ip] += $program
		}

	} Else {
		#add new entry with ip as key and an array as value
		#array contains program name
		$start_array = @($program)
		$program_connections.Add($ip, $start_array)
	}

}

return $program_connections
